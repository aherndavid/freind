<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FREIND - Your AI Companion</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #131413 0%, #1a1a1a 100%);
            color: #e0e0e0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            width: 100%;
            background: rgba(26, 26, 26, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(106, 45, 145, 0.3);
            padding: 40px;
            border: 2px solid #4a1a6b;
        }

        h1 {
            text-align: center;
            color: #6b2d91;
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 0 0 20px rgba(107, 45, 145, 0.5);
        }

        .tagline {
            text-align: center;
            color: #9d6bb3;
            font-size: 1.2em;
            margin-bottom: 30px;
        }

        .setup-section {
            background: rgba(74, 26, 107, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #4a1a6b;
        }

        .setup-section h3 {
            color: #6b2d91;
            margin-bottom: 10px;
        }

        .setup-section p {
            font-size: 0.9em;
            color: #b0b0b0;
            margin-bottom: 10px;
        }

        .setup-section a {
            color: #9d6bb3;
            text-decoration: none;
        }

        .setup-section a:hover {
            color: #b88dd6;
            text-decoration: underline;
        }

        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 12px;
            background: rgba(19, 20, 19, 0.8);
            border: 2px solid #4a1a6b;
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 1em;
            margin: 10px 0;
            transition: all 0.3s;
        }

        input[type="text"]:focus, input[type="password"]:focus {
            outline: none;
            border-color: #6b2d91;
            box-shadow: 0 0 15px rgba(107, 45, 145, 0.3);
        }

        button {
            background: linear-gradient(135deg, #4a1a6b 0%, #6b2d91 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
            margin: 5px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(107, 45, 145, 0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .google-signin {
            background: white;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-weight: bold;
        }

        .google-signin:hover {
            background: #f0f0f0;
        }

        #chat-container {
            background: rgba(19, 20, 19, 0.6);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            min-height: 300px;
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #4a1a6b;
        }

        .message {
            margin: 15px 0;
            padding: 12px;
            border-radius: 8px;
            line-height: 1.6;
        }

        .user-message {
            background: rgba(74, 26, 107, 0.3);
            border-left: 4px solid #6b2d91;
        }

        .ai-message {
            background: rgba(107, 45, 145, 0.2);
            border-left: 4px solid #9d6bb3;
        }

        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        #mic-button {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            font-size: 2em;
            background: linear-gradient(135deg, #4a1a6b 0%, #6b2d91 100%);
            border: 4px solid #6b2d91;
            transition: all 0.3s;
        }

        #mic-button:hover {
            transform: scale(1.1);
            box-shadow: 0 0 30px rgba(107, 45, 145, 0.6);
        }

        #mic-button.listening {
            background: linear-gradient(135deg, #8b1a6b 0%, #bb2d91 100%);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 20px rgba(187, 45, 145, 0.4); }
            50% { box-shadow: 0 0 40px rgba(187, 45, 145, 0.8); }
        }

        select {
            padding: 10px;
            background: rgba(19, 20, 19, 0.8);
            border: 2px solid #4a1a6b;
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 1em;
            cursor: pointer;
        }

        .status {
            text-align: center;
            padding: 15px;
            background: rgba(74, 26, 107, 0.2);
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #4a1a6b;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(107, 45, 145, 0.3);
            border-top-color: #6b2d91;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .user-info {
            text-align: center;
            padding: 10px;
            background: rgba(74, 26, 107, 0.2);
            border-radius: 8px;
            margin: 10px 0;
            display: none;
        }

        .user-info.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>FREIND</h1>
        <p class="tagline">Your AI Companion - Powered by Claude</p>

        <div class="setup-section">
            <h3>üîê Google Drive Setup</h3>
            <p>Get your Client ID from <a href="https://console.cloud.google.com" target="_blank">Google Cloud Console</a><br>
            Guide: console.cloud.google.com ‚Üí APIs & Services ‚Üí Credentials</p>
            <input type="text" id="client-id" placeholder="Paste your Google Client ID here">
            <button onclick="saveClientId()">Save Client ID</button>
        </div>

        <div class="setup-section">
            <h3>ü§ñ Claude API Setup</h3>
            <p>Get your API key from: <a href="https://console.anthropic.com" target="_blank">console.anthropic.com</a></p>
            <input type="password" id="api-key" placeholder="Paste your Claude API key here">
            <button onclick="saveApiKey()">Save API Key</button>
        </div>

        <div class="user-info" id="user-info"></div>

        <button class="google-signin" onclick="signInWithGoogle()" id="google-signin-btn">
            üîê Sign in with Google Drive
            <span style="font-size:0.8em;display:block;font-weight:normal;">Sign in to sync your conversations across all devices</span>
        </button>

        <div id="chat-container">
            <div class="status">
                Welcome to FREIND! I'm your AI companion. Complete the setup above, then click the microphone to start talking. Your conversations will automatically save to Google Drive and sync across all your devices.
            </div>
        </div>

        <div class="status" id="status">‚è≥ Processing...</div>

        <div class="controls">
            <button id="mic-button" onclick="toggleListening()" disabled>üé§</button>
            <span id="mic-status">Complete setup to begin</span>
        </div>

        <div class="controls">
            <select id="voice-select" onchange="saveVoicePreference()">
                <option value="male">üéôÔ∏è Male</option>
                <option value="female-soft">üë© Female Soft</option>
                <option value="female-sexy">üíã Female Sexy</option>
                <option value="robot">ü§ñ Robot (WarGames)</option>
            </select>
            <button onclick="syncToDrive()">üîÑ Sync</button>
            <button onclick="clearChat()">üóëÔ∏è Clear</button>
        </div>
    </div>

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
        let isListening = false;
        let recognition;
        let conversationHistory = [];
        let apiKey = '';
        let clientId = '';
        let accessToken = '';
        let userEmail = '';
        let folderName = 'FREIND';
        let conversationFileId = null;

        // Initialize
        window.onload = function() {
            loadSettings();
            loadConversation();
            updateStatus('Ready to begin!', false);
        };

        // Save Client ID
        function saveClientId() {
            const input = document.getElementById('client-id');
            clientId = input.value.trim();
            if (clientId) {
                localStorage.setItem('google_client_id', clientId);
                alert('Client ID saved! Now sign in with Google.');
                initializeGoogleSignIn();
            }
        }

        // Save API Key
        function saveApiKey() {
            const input = document.getElementById('api-key');
            apiKey = input.value.trim();
            if (apiKey) {
                localStorage.setItem('claude_api_key', apiKey);
                alert('API key saved!');
                checkReadiness();
            }
        }

        // Load saved settings
        function loadSettings() {
            apiKey = localStorage.getItem('claude_api_key') || '';
            clientId = localStorage.getItem('google_client_id') || '';
            const savedVoice = localStorage.getItem('voice_preference');
            
            if (apiKey) document.getElementById('api-key').value = apiKey;
            if (clientId) {
                document.getElementById('client-id').value = clientId;
                initializeGoogleSignIn();
            }
            if (savedVoice) document.getElementById('voice-select').value = savedVoice;
            
            checkReadiness();
        }

        // Initialize Google Sign-In with new Google Identity Services
        function initializeGoogleSignIn() {
            if (!clientId) return;

            window.google.accounts.id.initialize({
                client_id: clientId,
                callback: handleCredentialResponse,
                scope: 'https://www.googleapis.com/auth/drive.file'
            });
        }

        // Sign in with Google
        function signInWithGoogle() {
            if (!clientId) {
                alert('Please enter and save your Google Client ID first!');
                return;
            }

            const client = google.accounts.oauth2.initTokenClient({
                client_id: clientId,
                scope: 'https://www.googleapis.com/auth/drive.file',
                callback: (response) => {
                    if (response.access_token) {
                        accessToken = response.access_token;
                        getUserInfo();
                        document.getElementById('google-signin-btn').textContent = '‚úì Signed in to Google Drive';
                        document.getElementById('google-signin-btn').style.background = '#4CAF50';
                        checkReadiness();
                    }
                }
            });
            
            client.requestAccessToken();
        }

        // Get user info
        async function getUserInfo() {
            try {
                const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                    headers: { 'Authorization': 'Bearer ' + accessToken }
                });
                const data = await response.json();
                userEmail = data.email;
                const userInfo = document.getElementById('user-info');
                userInfo.textContent = `Signed in as: ${userEmail}`;
                userInfo.classList.add('active');
                
                // Load conversations from Drive
                await loadFromDrive();
            } catch (error) {
                console.error('Error getting user info:', error);
            }
        }

        // Handle credential response (not used with token client but kept for reference)
        function handleCredentialResponse(response) {
            console.log("Credential response:", response);
        }

        // Check if ready to use
        function checkReadiness() {
            const ready = apiKey && accessToken;
            document.getElementById('mic-button').disabled = !ready;
            document.getElementById('mic-status').textContent = ready ? 'Click to speak' : 'Complete setup to begin';
            
            if (ready) {
                initializeSpeechRecognition();
            }
        }

        // Initialize speech recognition
        function initializeSpeechRecognition() {
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';

                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    addMessage('user', transcript);
                    sendToClaude(transcript);
                };

                recognition.onerror = function(event) {
                    console.error('Speech recognition error:', event.error);
                    updateStatus('Error: ' + event.error, false);
                    isListening = false;
                    updateMicButton();
                };

                recognition.onend = function() {
                    isListening = false;
                    updateMicButton();
                };
            }
        }

        // Toggle listening
        function toggleListening() {
            if (!recognition) return;

            if (isListening) {
                recognition.stop();
                isListening = false;
            } else {
                recognition.start();
                isListening = true;
                updateStatus('Listening...', true);
            }
            updateMicButton();
        }

        // Update mic button
        function updateMicButton() {
            const btn = document.getElementById('mic-button');
            if (isListening) {
                btn.classList.add('listening');
                document.getElementById('mic-status').textContent = 'Listening...';
            } else {
                btn.classList.remove('listening');
                document.getElementById('mic-status').textContent = 'Click to speak';
            }
        }

        // Send to Claude
        async function sendToClaude(text) {
            updateStatus('Thinking...', true);
            
            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1000,
                        messages: [
                            ...conversationHistory,
                            { role: 'user', content: text }
                        ]
                    })
                });

                const data = await response.json();
                const reply = data.content[0].text;
                
                conversationHistory.push({ role: 'user', content: text });
                conversationHistory.push({ role: 'assistant', content: reply });
                
                addMessage('ai', reply);
                speak(reply);
                saveConversation();
                updateStatus('Ready', false);
                
                // Auto-sync to Drive
                if (accessToken) {
                    await syncToDrive();
                }
            } catch (error) {
                console.error('Error:', error);
                updateStatus('Error: ' + error.message, false);
            }
        }

        // Add message to chat
        function addMessage(type, text) {
            const container = document.getElementById('chat-container');
            const message = document.createElement('div');
            message.className = `message ${type}-message`;
            message.textContent = text;
            container.appendChild(message);
            container.scrollTop = container.scrollHeight;
        }

        // Speak text
        function speak(text) {
            const utterance = new SpeechSynthesisUtterance(text);
            const voice = document.getElementById('voice-select').value;
            
            // Set voice characteristics
            switch(voice) {
                case 'male':
                    utterance.pitch = 0.8;
                    utterance.rate = 1.0;
                    break;
                case 'female-soft':
                    utterance.pitch = 1.3;
                    utterance.rate = 0.9;
                    break;
                case 'female-sexy':
                    utterance.pitch = 1.2;
                    utterance.rate = 0.8;
                    break;
                case 'robot':
                    utterance.pitch = 0.5;
                    utterance.rate = 0.7;
                    break;
            }
            
            speechSynthesis.speak(utterance);
        }

        // Save voice preference
        function saveVoicePreference() {
            const voice = document.getElementById('voice-select').value;
            localStorage.setItem('voice_preference', voice);
        }

        // Save conversation locally
        function saveConversation() {
            localStorage.setItem('freind_conversation', JSON.stringify(conversationHistory));
        }

        // Load conversation locally
        function loadConversation() {
            const saved = localStorage.getItem('freind_conversation');
            if (saved) {
                conversationHistory = JSON.parse(saved);
                conversationHistory.forEach(msg => {
                    addMessage(msg.role === 'user' ? 'user' : 'ai', msg.content);
                });
            }
        }

        // Find or create FREIND folder in Drive
        async function findOrCreateFolder() {
            try {
                // Search for existing folder
                const searchResponse = await fetch(
                    `https://www.googleapis.com/drive/v3/files?q=name='${folderName}' and mimeType='application/vnd.google-apps.folder' and trashed=false`,
                    { headers: { 'Authorization': 'Bearer ' + accessToken } }
                );
                const searchData = await searchResponse.json();
                
                if (searchData.files && searchData.files.length > 0) {
                    return searchData.files[0].id;
                }
                
                // Create folder if it doesn't exist
                const createResponse = await fetch('https://www.googleapis.com/drive/v3/files', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + accessToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: folderName,
                        mimeType: 'application/vnd.google-apps.folder'
                    })
                });
                const createData = await createResponse.json();
                return createData.id;
            } catch (error) {
                console.error('Error with folder:', error);
                return null;
            }
        }

        // Sync to Google Drive
        async function syncToDrive() {
            if (!accessToken) {
                alert('Please sign in with Google first!');
                return;
            }
            
            updateStatus('Syncing to Drive...', true);
            
            try {
                const folderId = await findOrCreateFolder();
                if (!folderId) {
                    throw new Error('Could not create/find folder');
                }
                
                const content = JSON.stringify({
                    history: conversationHistory,
                    lastUpdated: new Date().toISOString()
                });
                
                const metadata = {
                    name: 'freind_conversations.json',
                    mimeType: 'application/json',
                    parents: [folderId]
                };
                
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', new Blob([content], { type: 'application/json' }));
                
                let url = 'https://www.googleapis.com/upload/drive/v3/files';
                let method = 'POST';
                
                if (conversationFileId) {
                    url = `https://www.googleapis.com/upload/drive/v3/files/${conversationFileId}`;
                    method = 'PATCH';
                }
                
                const response = await fetch(url + '?uploadType=multipart', {
                    method: method,
                    headers: { 'Authorization': 'Bearer ' + accessToken },
                    body: form
                });
                
                const data = await response.json();
                conversationFileId = data.id;
                
                updateStatus('Synced to Drive ‚úì', false);
                setTimeout(() => updateStatus('Ready', false), 2000);
            } catch (error) {
                console.error('Sync error:', error);
                updateStatus('Sync failed: ' + error.message, false);
            }
        }

        // Load from Google Drive
        async function loadFromDrive() {
            if (!accessToken) return;
            
            try {
                const folderId = await findOrCreateFolder();
                if (!folderId) return;
                
                // Search for conversation file
                const searchResponse = await fetch(
                    `https://www.googleapis.com/drive/v3/files?q=name='freind_conversations.json' and '${folderId}' in parents and trashed=false`,
                    { headers: { 'Authorization': 'Bearer ' + accessToken } }
                );
                const searchData = await searchResponse.json();
                
                if (searchData.files && searchData.files.length > 0) {
                    conversationFileId = searchData.files[0].id;
                    
                    // Download file content
                    const downloadResponse = await fetch(
                        `https://www.googleapis.com/drive/v3/files/${conversationFileId}?alt=media`,
                        { headers: { 'Authorization': 'Bearer ' + accessToken } }
                    );
                    const data = await downloadResponse.json();
                    
                    if (data.history) {
                        conversationHistory = data.history;
                        document.getElementById('chat-container').innerHTML = '<div class="status">Loaded from Google Drive ‚úì</div>';
                        conversationHistory.forEach(msg => {
                            addMessage(msg.role === 'user' ? 'user' : 'ai', msg.content);
                        });
                        saveConversation();
                    }
                }
            } catch (error) {
                console.error('Load error:', error);
            }
        }

        // Clear chat
        function clearChat() {
            if (confirm('Clear all conversations? This will delete both local and Drive data.')) {
                conversationHistory = [];
                document.getElementById('chat-container').innerHTML = '<div class="status">Chat cleared</div>';
                localStorage.removeItem('freind_conversation');
                
                if (conversationFileId && accessToken) {
                    fetch(`https://www.googleapis.com/drive/v3/files/${conversationFileId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': 'Bearer ' + accessToken }
                    });
                    conversationFileId = null;
                }
            }
        }

        // Update status
        function updateStatus(text, loading) {
            const status = document.getElementById('status');
            status.innerHTML = loading ? `<span class="loading"></span> ${text}` : text;
        }
    </script>
</body>
</html>
